---
# Playbook for bootstrapping node. This script should be run when node is being added to cluster, either as replacement or new node.
# Script will erase data and put node in joining state, while data is not streamed off other nodes and then node will function properly in ring.

# --extra-vars="bootstrap_node=cassandra.hostname" is used to pass host which needs to be bootstrapped.
- name: Bootstrap Cassandra Node
  hosts: "{{ bootstrap_node }}"
  become: yes
  become_user: root
  become_method: sudo
  pre_tasks:
    - name: Deleting Cassandra Folders (data, commitlog, hints)
      file:
        state: absent
        path: "{{ cassandra_data_dir }}/{{ item }}"
      with_items:
        - data
        - commitlog
        - hints
        - saved_caches
    - name: Add Cassandra replace ip line to cassandra-env file
      lineinfile: dest={{ cassandra_configuration_dir }}/cassandra-env.sh
        line='JVM_OPTS="$JVM_OPTS -Dcassandra.replace_address={{ bootstrap_node }}"'
  roles:
    - cassandra
  post_tasks:
    - name: Removing replace ip line from env file
      lineinfile: dest={{ cassandra_configuration_dir }}/cassandra-env.sh state=absent
        regexp='^JVM_OPTS="\$JVM_OPTS -Dcassandra.replace_address={{ bootstrap_node }}"'
